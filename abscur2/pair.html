<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ПАРНЫЕ ВАЛЮТНЫЕ КУРСЫ</title>
    
</head>
<body>

<nav>
    <ul>
        <li><a href="index.html">ГЛАВНАЯ</a></li>
        <li><a href="pair.html">ПАРНЫЕ ВАЛЮТНЫЕ КУРСЫ</a></li>
        <li><a href="abs.html">АБСОЛЮТНЫЕ КУРСЫ</a></li>
    </ul>
</nav>


<div id="currentPair">
    Загрузка имени текущей пары
</div>

<br/>

<div id="pairsLinks">
    Загрузка ссылок на другие пары
</div>

<br/>

<div id="div_chart" style="width: 99%; height: 400px;">
    Загрузка графиков текущей пары
</div>

<br/>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-latest.js"></script>

<script type="text/javascript">
    // google.charts.load('current', {'packages':['table']});
    google.charts.load('current', {'packages':['annotationchart']});
    var ssid = "1azH80JUolc4whN_Uu3Myrrsyv1nEScJ8LK1Lecn0uH4" ;
    
    // текущая пара
    var cur_pair = "" ;
    var cur_pair_num = 0 ;
    var dates_col ;
    
    google.charts.setOnLoadCallback(function (){
        
        start("'Парные валютные курсы'!B1:CH1",function(response){
            // строка имен пар
            var data = response.getDataTable();
            var cnt_c = data.getNumberOfColumns() ;

            // текущая пара
            var my_par = $.urlParam("pair") ;
            cur_pair = "" ;
            for(var i=0;i<cnt_c;i++)
                if(data.getValue(0,i) == my_par){
                    cur_pair = data.getValue(0,i) ;
                    cur_pair_num = i ;
                }
            if(cur_pair.length <= 0){
                cur_pair_num = Math.floor(Math.random()*cnt_c)
                cur_pair = data.getValue(0,cur_pair_num) ;
            } 
            $('#currentPair').text('Текущая пара: ' + cur_pair) ;
            
            // ссылки на другие пары
            var pairsLinks = "" ;
            for(var i=0;i<cnt_c;i++){
                var pair = data.getValue(0,i) ;
                if(pair == cur_pair)
                    pairsLinks += '<b>' + pair.toUpperCase() + '</b> ' ;
                else
                    pairsLinks += '<a href=?pair=' + encodeURIComponent(pair) + '>' + pair.toUpperCase() + '</a> ' ;
            }
            $('#pairsLinks').html(pairsLinks) ;

            
            start("'Парные валютные курсы'!A2:A",function(response){
                // столбец дат
                dates_col = response.getDataTable() ;
                var cnt_r = dates_col.getNumberOfRows() ;
                console.log(cnt_r) ;

                var pairAlpha = getAlpha(cur_pair_num) ;
                console.log(pairAlpha) ;

                start("'Парные валютные курсы'!" + pairAlpha + "2:" + pairAlpha,function(response){
                    var pair_col = response.getDataTable() ;
                    console.log(pair_col.getNumberOfRows()) ;

                    var data = dates_col.clone() ;
                    data.addColumn('number',cur_pair) ;
                    for(var i=0;i<data.getNumberOfRows();i++)
                        data.setValue(i,1,pair_col.getValue(i,0)) ;

                    var options = {
                        // height: 300,
                    } ;

                    var chart = new google.visualization.AnnotationChart(document.getElementById('div_chart'));

                    chart.draw(data, options);
                }) ;
            }) ;
        
        }) ;
    
    }) ;

    // -------------------------------------------------------
    // библиотека

    $.urlParam = function(name){
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        if (results==null)
        {
            return "" ;
        }
        else
        {
            return decodeURIComponent(results[1]) || "" ;
        } 
    }
    
    
    function start(query,func) {
        var queryString = encodeURIComponent(query);
        var URL = 'https://docs.google.com/spreadsheets/d/' + ssid + '/gviz/tq?range=' + queryString  ;
        var query = new google.visualization.Query(URL) ;
        query.send(func);
    } ;

    function getAlpha(index)
    {
        var abc = "A B C D E F G H I J K L M N O P Q R S T U V W X Y Z".split(/[\s\t ]+/) ;
        var i = index + 1 ;
        var mr = Math.floor(i/26) ;
        var lr = i - mr*26 ;
        var alpha = abc[lr] ;
        if(mr>0) 
            alpha = abc[mr-1] + alpha ;
        return alpha ;
    }
</script>



</body>
</html>
